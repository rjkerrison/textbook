<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="keywords" content="html,javascript,tutorial,loki,tva" />

    <meta prefix="og: http://ogp.me/ns#" property="og:type" content="website" />
    <meta
      prefix="og: http://ogp.me/ns#"
      property="og:title"
      content="Pruning Loki | An HTML5 and JavaScript Game"
    />

    <meta
      prefix="og: http://ogp.me/ns#"
      property="og:description"
      content="A guide to creating a simple HTML5 game that uses canvas 2D context to create a 'pruning' effect like on the Loki show on Disney+"
    />

    <meta
      prefix="og: http://ogp.me/ns#"
      property="og:image"
      name="image"
      content="https://rjkerrison.co.uk/textbook/canvas/prune/images/wide-screenshot.jpg"
    />

    <meta
      prefix="og: http://ogp.me/ns#"
      property="og:url"
      content="https://rjkerrison.co.uk/textbook/canvas/prune/learn"
    />
    <meta
      prefix="og: http://ogp.me/ns#"
      name="author"
      property="og:author"
      content="Robin James Kerrison"
    />
    <meta
      prefix="og: http://ogp.me/ns#"
      property="og:publish_date"
      name="publish_date"
      content="2021-07-28T19:57:51.000Z"
    />
    <meta property="og:locale" content="en_GB" />
    <meta
      property="article:published_time"
      name="publish_date"
      content="2021-07-28T19:57:51.000Z"
    />
    <meta name="pdate" content="20210728" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@robinjames_" />
    <meta name="twitter:creator" content="@robinjames_" />
    <meta
      name="twitter:domain"
      content="https://rjkerrison.co.uk/textbook/canvas/prune/learn"
    />
    <meta
      name="twitter:title"
      content="Pruning Loki | A guide to creating an HTML5 and JavaScript Game"
    />
    <meta
      name="twitter:description"
      content="A guide to creating a simple HTML5 game that uses canvas 2D context to create a 'pruning' effect like on the Loki show on Disney+"
    />
    <meta
      name="twitter:image"
      content="https://rjkerrison.co.uk/textbook/canvas/prune/images/wide-screenshot.jpg"
    />
    <meta
      name="twitter:image:alt"
      property="og:image:alt"
      content="A screenshot of the Loki game with Loki being removed gradually from view"
    />

    <title>
      Pruning Loki Browser Game | Learning Canvas in JavaScript and HTML at the
      TVA | RJK Textbook
    </title>
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/github-dark.min.css"
    />
    <link rel="stylesheet" href="../../../shared/styles/font-me-up.css" />
    <link rel="stylesheet" href="../styles/shared.css" />
    <link rel="stylesheet" href="../styles/learn.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js"></script>
    <script src="../../../shared/js/font-me-up.js"></script>
    <script src="../../../shared/js/code-handling.js"></script>
    <script src="https://rjkerrison.co.uk/google-analytics.js"></script>
  </head>
  <body>
    <header>
      <div class="flex-row">
        <button class="nav-toggle">^</button>
        <div class="flex-row">
          <h1 title="For all time. Always.">
            <div>Pruning</div>
            <div class="font-me-up">Loki</div>
          </h1>

          <p class="lg-only">Want to <a href="../">play the game</a>?</p>
        </div>
      </div>
      <nav>
        <p class="sm-only"><a href="../">Play the game</a></p>
        <p class="sm-only">Sections:</p>
        <ul class="flex-row small-screen-flex-column">
          <li>
            <a class="font-me-up font-me-up-static" href="#initialising"
              >Initialising</a
            >
          </li>
          <li>
            <a class="font-me-up font-me-up-static" href="#game"
              >Game mechanics</a
            >
          </li>
          <li>
            <a class="font-me-up font-me-up-static" href="#canvas">Canvas</a>
          </li>
          <li>
            <a class="font-me-up font-me-up-static" href="#animation"
              >Animation</a
            >
          </li>
          <li>
            <a class="font-me-up font-me-up-static" href="#click">Click</a>
          </li>
          <li>
            <a class="font-me-up font-me-up-static" href="#doors">Doors</a>
          </li>
        </ul>
      </nav>
    </header>
    <main>
      <div class="section-inner">
        <p>
          So you wanna know how we control the timeline? Start with the big
          button below, or jump to a section:
        </p>
        <ul>
          <li>
            <a href="#initialising">Initialising with the page</a>
          </li>
          <li>
            <a href="#game">Defining high-level game mechanics</a>
          </li>
          <li>
            <a href="#canvas">Setting up the right canvas</a>
          </li>
          <li>
            <a href="#animation">Defining our animation</a>
          </li>
          <li>
            <a href="#click">Handling the user's click</a>
          </li>
          <li>
            <a href="#doors">Opening the doors</a>
          </li>
        </ul>
      </div>
      <a href="#initialising" class="loki-button font-me-up">Start</a>
    </main>
    <section id="initialising">
      <h2>Initialising with the page</h2>
      <div class="section-inner">
        <p>
          We need to start somewhere, and in our initialisation, we'll need to
          have a reference to everything on our HTML page to which our
          JavaScript will need to refer. In our case, it's quite simple. It's
          just:
        </p>
        <ul>
          <li>the container into which we insert our clickable Lokis;</li>
          <li>the button which starts the game;</li>
          <li>and the element in which we show our score.</li>
        </ul>
        <pre><code data-src="../js/main.js"></code></pre>
      </div>

      <a href="#game" class="loki-button font-me-up">Next</a>
    </section>
    <section id="game">
      <h2>Defining high-level game mechanics</h2>
      <div class="section-inner">
        <p>
          We know we'll have a game which will start, end, and keep score. We
          also know that it will advance in steps. We can therefore write a lot
          of our
          <em>boilerplate</em> game logic into place, even before we know the
          specifics.
        </p>
        <pre><code data-src="../js/game.js"></code></pre>
        <p>
          There are some high-level names of processes here which we define
          elsewhere:
        </p>
        <ul>
          <li>
            <code>createCanvas()</code> is declared as part of our
            <a href="#canvas">canvas</a> section
          </li>
          <li>
            <code>attachImages()</code> is part of
            <a href="#drawing">canvas drawing</a> subsection
          </li>
          <li>
            <code>getPruneClickListener()</code> is in a section of our code
            dedicated to
            <a href="#click">handling the user's click</a>
          </li>
        </ul>
        <p>
          In a config global variable, we can give ourselves easy access to
          things like timings and sizes that we might want to tweak as we
          develop the game.
        </p>
        <pre><code data-src="../js/config.js"></code></pre>
        <p>
          Similarly, there might be some tools we use in lots of our sections of
          code, and for those we have
          <code>./utils.js</code>.
        </p>
        <pre><code data-src="../js/utils.js"></code></pre>
      </div>
      <a href="#canvas" class="loki-button font-me-up">Next</a>
    </section>
    <section id="canvas">
      <h2>Setting up the right canvas</h2>
      <div class="section-inner">
        <p>
          There's a fair bit of work to get our canvas set up, because we need
          to have it work for multiple Lokis, of different sizes. We'll also
          need to draw the images and add the click events dynamically.
        </p>
        <p>
          We create a new canvas element for every Loki we want to show, because
          we want a one-to-one relationship with the images and the click event.
        </p>
        <p>
          Handling clicks inside a canvas is difficult: we'd have to check the
          coordinates of the click. Clearing specific rectangles from within a
          canvas would also mean keeping track of the exact place where we drew
          each Loki. The simplest solution for removing a Loki from our screen
          is to remove the whole canvas element.
        </p>
        <pre><code data-src="../js/create-canvas.js"></code></pre>
        <h3 id="drawing">Drawing images on a canvas</h3>
        <p>
          With the canvas we've created, we'll be able to attach the image. Note
          that we don't actually execute this until the
          <a href="#doors">doors</a> are ready.
        </p>
        <p>
          Some of the important work here was done in the definition of
          <code>loadImages()</code> which is a responsibility we've left to the
          <a href="#game">game mechanics</a>. All we need to know is that
          <code>chosenImage</code> is a valid <code>Image()</code> instance.
        </p>
        <pre><code data-src="../js/attach-image.js"></code></pre>
      </div>

      <a href="#animation" class="loki-button font-me-up">Next</a>
    </section>
    <section id="animation">
      <h2>Defining our animation</h2>
      <div class="section-inner">
        <p>
          This is where we get quite complicated. What we're trying to do is
          simple in theory: make each Loki look like they're being pruned. In
          practice, this means animating lots of frames where the amount of Loki
          which is clipped is increasing, and the area soon-to-be-clipped is
          painted some hauntingly pastel colour.
        </p>
        <picture
          ><img src="../images/mobius-prune.jpg" alt="Mobius being pruned"
        /></picture>
        <p>
          A little bit of blue, a bit of yellow, throw in some purple and we're
          good to go. For our pruning effect, We just need to randomly pick out
          one of those colours, and draw a circle of a given size.
        </p>
        <pre><code lang="javascript" data-src="../js/pruning-effect.js"></code></pre>
        <p>
          And then, to keep things simple, we clip a circle that's just a little
          smaller. For that, we'll need to be able to clip a circle.
        </p>
        <pre><code lang="javascript" data-src="../js/clipping-circle.js"></code></pre>
        <p>
          Looking good! Finally, the pruning animation will keep track of where
          the circles are, how big they need to be, and it will call our drawing
          and clipping functions.
        </p>
        <pre><code lang="javascript" data-src="../js/pruning-animation.js"></code></pre>
      </div>
      <a href="#click" class="loki-button font-me-up">Next</a>
    </section>
    <section id="click">
      <h2>Handling the user's click</h2>
      <div class="section-inner">
        <p>
          As is often the case when we're working with JavaScript, we want to
          respond to a user click. In our game, we start the
          <a href="#animation">animation</a> when the user clicks a Loki!
        </p>
        <p>
          Essentially, we just need to kick off a bunch of effects. The most
          complicated thing about our click listener is that we're generating
          the callback based on some parameters — this is often really helpful,
          when there's information or elements not available on pageload but
          which we can pass to a function builder like this later.
        </p>
        <pre><code lang="javascript" data-src="../js/prune-click-listener.js"></code></pre>
        <p>
          Notice how we're using <code>setTimeout()</code> to delay two of the
          effects: removing the Loki and showing the next one.
        </p>
      </div>
      <a href="#doors" class="loki-button font-me-up">Next</a>
    </section>

    <section id="doors">
      <h2>Opening the doors</h2>
      <div class="section-inner">
        <p>
          Our bonus effect is doors which open and close. This complicates the
          drawing of our Lokis a little bit, because we want Loki to appear
          after we've finished drawing the door, and stay visible while we close
          the door.
        </p>
        <pre><code data-src="../js/doors.js"></code></pre>
      </div>
    </section>
    <footer>
      <p>Play the game at <a href="../">/prune</a>.</p>
    </footer>
    <script>
      const nav = document.querySelector('header nav')
      const toggles = document.querySelectorAll('.nav-toggle, header nav a')
      const toggleOpen = (el) => el.classList.toggle('open')
      toggles.forEach((toggle) => {
        toggle.addEventListener('click', () => {
          toggleOpen(nav)
          toggles.forEach(toggleOpen)
        })
      })
    </script>
  </body>
</html>
